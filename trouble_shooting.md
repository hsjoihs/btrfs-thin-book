Btrfs使用時に遭遇する様々なトラブルへの対処方法を逆引き式に紹介

btrfs-progsのソースは[こちら](git://git.kernel.org/pub/scm/linux/kernel/git/kdave/btrfs-progs.git)から入手できます。

# RAIDを構成するデバイスのうち1つが認識されなくなった

btrfs-replace

# 書き込み時にENOSPCで異常終了した

不要なファイルを削除。データ、メタデータ共に複数ファイル/サブボリュームで共有されている可能性があるので、duコマンドの結果をもとに共有されていないファイルを探すのが効果的。

# 空のディレクトリを削除できない

それはsubvolume。subvolume deleteサブコマンドによって削除が必要

# ストレージプールに十分な空き領域があるにも関わらず、btrfs balanceがENOSPCで異常終了した

# 特定のストレージに関してI/Oエラーが多発するようになった

バックアップした上で、btrfs replace

# ファイルシステムに書き込めなくなった

Btrfsに問題が発生してromountになっている。dmesgを見て

# mount時に自動的に動作するbalanceに失敗してmountできない、あるいはシステムがクラッシュする

skip_balanceマウントオプション

# mountできなくなった

dmesgにBtrfsに関するエラーメッセージが表示されているはずです(典型的には行頭が"BTRFS")。メッセージに応じた対策をとってください。
それでもダメならバックアップからデータを復元。

バックアップが存在しない、なるべく新しいデータを復旧したいという場合はbtrfs-restore。

最終手段。btrfs check --repair

# dmesgにBtrfsに関するメッセージが出るようになった

## mount時に "BTRFS info (device XXX): The free space cache file (YYY) is invalid. skip it" というメッセージが出る

とくに対処の必要はありません。空き領域を管理するキャッシュ領域が壊れたことが原因です。Btrfsは壊れたキャッシュを自動的に廃棄、再構築します。再構築する間は空き領域の検索が必要なファイル作成、書き込みなどの各種処理の性能が劣化します。

## "BTRFS: could not find root 8" というメッセージが出る

quota機能を使っていないファイルシステムに対して出力されるものであり、とくに害はありません。最近のBtrfsにおいてはこのメッセージは出なくなっています。

## 過去のsysylogに"chunk tree"という文字列を含むエラーが出力されている。

どのデバイスにどのデータを配置するかという情報が入っているchunk treeというメタデータが壊れている可能性があります。次のコマンドによって、ファイルシステムをスキャンしてchunk treeを復元できます。

```
$ btrfs-rescue chunk-recovery /dev/sdb2
```

このコマンドはストレージプールのすべてを走査するため、非常に時間がかかる恐れがあります。

## replay, recover, log_tree という文字列を含んだバックトレースが出ている

バックトレースはたとえば以下のようなものです。

```
? replay_one_dir_item+0xb5/0xb5 [btrfs]
? walk_log_tree+0x9c/0x19d [btrfs]
? btrfs_read_fs_root_no_radix+0x169/0x1a1 [btrfs]                                                                                                                                           ? btrfs_recover_log_trees+0x195/0x29c [btrfs]
? replay_one_dir_item+0xb5/0xb5 [btrfs]                                                                                                                                                     ? btree_read_extent_buffer_pages+0x76/0xbc [btrfs]                                                                                                                                          ? open_ctree+0xff6/0x132c [btrfs]
```
これはBtrfsが内部で管理しているログツリーと呼ばれるメタデータが壊れているためマウントが失敗したことを示しています。ファイルシステムがクラッシュした直後のmountがこの理由によって失敗することがあります。壊れたログは次のコマンドによって削除できます。その後もう一度ファイルシステムのmountを試してください。

```
$ btrfs-rescue zero-log /dev/sda2
```

このログツリーの削除によってどのような影響があるかについて説明します。Btrfsはメモリ上にキャッシュされたファイルシステムのデータを定期的(デフォルトでは30秒に一回)にストレージに同期させています。この同期操作のことをトランザクションコミットと呼びます。fsync()やO_SYNCで開いたファイルへの書き込みなどの同期書き込みについては、一旦ストレージ上のログツリーに保存した上で、トランザクションコミット時にデータ領域に反映させます。ログツリーを削除すると、最後のトランザクションコミットからクラッシュ時までの同期書き込みの結果を失います。

## それ以外のログが出ている、あるいはとくにログが出ていない

大きく分けて次の2つの可能性が考えられます。

- スーパーブロック(後述)が壊れている
- root tree(後述)が壊れている

それぞれについて対処方法を説明します。

## スーパーブロックが壊れている場合

スーパーブロックとは、mountしようとしたストレージがBtrfsに属していることを示すと共に、各種管理情報を保持しているメタデータです。このデータにはバックアップされていますので、スーパーブロックが壊れている場合は次のコマンドによって復元できます。

```
$ btrfs-rescue chunk-super /dev/sda2
```

## root treeが壊れている場合

どの場所にどんなデータ/メタデータが配置されているかを管理するroot treeというメタデータが壊れている場合があります。次のコマンドを実行してください。


```
mount -o usebackuproot /dev/sdb2
```

root treeの内容は定期的に更新されていきますが、過去のroot treeをバックアップとして保存しています。上記コマンドは、最新のroot treeのかわりにバックアップ用のroot treeを使用してBtrfsファイルシステムをmountします。mountに成功したとしても、root treeが過去のものである以上、データも過去のものになっていることにご注意ください。
