本章はBtrfs使用時に遭遇する様々なトラブルへの対処方法を逆引き式に紹介します。

# RAIDを構成するデバイスのうち1つが認識されなくなった

btrfs-replace

# 書き込み時にENOSPCで異常終了した

他のファイルシステム同様、不要なファイルを削除して空き領域を作ってください。Btrfsにおいてはデータ、メタデータ共に複数ファイル/サブボリュームの間で共有されている可能性があるので、あるファイルを消したとしても必ずしもそのファイルのサイズぶんだけファイルシステムの空き領域が増えるとは限りません。不要なスナップショットを消したり、`btrfs filesystem du`を活用して、他のファイル/サブボリュームと共有されていないファイルを探して重点的に削除するのが効果的です。

# 空のディレクトリの削除が失敗する

恐らくディレクトリではなくサブボリュームを削除しようとしています。`btrfs subvolume list`コマンドによって削除しようとしているものがサブボリュームかどうかを確認してください。サブボリュームだった場合は`btrfs subvolume delete`サブコマンドによって削除してください。

# ストレージプールに十分な空き領域があるにも関わらず、btrfs balanceがENOSPCで異常終了した

# 特定のストレージに関してI/Oエラーが多発するようになった

バックアップした上で、btrfs replace

# ファイルシステムに書き込めなくなった

Btrfsに問題が発生してromountになっている。dmesgを見て

# mount時にbalance処理が動作してシステムがクラッシュする

skip_balanceマウントオプション

# dmesgにBtrfsに関するメッセージが出るようになった

## mount時に "BTRFS info (device XXX): The free space cache file (YYY) is invalid. skip it" というメッセージが出る

とくに対処の必要はありません。空き領域を管理するキャッシュ領域が壊れたことが原因です。Btrfsは壊れたキャッシュを自動的に廃棄、再構築します。再構築する間は空き領域の検索が必要なファイル作成、書き込みなどの各種処理の性能が劣化します。

## "BTRFS: could not find root 8" というメッセージが出る

quota機能を使っていないファイルシステムに対して出力されるものであり、とくに害はありません。最近のBtrfsにおいてはこのメッセージは出なくなっています。

# mountできなくなった

基本的にはシステムの整合性が採れている状態に採取されたバックアップからファイルシステムを復旧してください。ここに記載するのは、バックアップをとっていない、あるいは最終バックアップ後の可能な限り最新のデータを復旧したいという場合の対処法です。この節に記載の対処は前から順番に試してください。

## mountできないファイルシステムからファイルを吸い出す

次のコマンドによって、ファイルシステムの中に存在するファイルを、mountすることなく吸い出せます。

```
$ btrfs-restore

```

# mountに必要なメタデータの復元

過去のカーネルログ、およびdmesgにBtrfsに関するエラーメッセージ(典型的には行頭が"BTRFS")をもとに対処してください。

## replay, recover, log_tree という文字列を含んだバックトレースが出ている

バックトレースはたとえば以下のようなものです。

```
? replay_one_dir_item+0xb5/0xb5 [btrfs]
? walk_log_tree+0x9c/0x19d [btrfs]
? btrfs_read_fs_root_no_radix+0x169/0x1a1 [btrfs]                                                                                                                                           ? btrfs_recover_log_trees+0x195/0x29c [btrfs]
? replay_one_dir_item+0xb5/0xb5 [btrfs]                                                                                                                                                     ? btree_read_extent_buffer_pages+0x76/0xbc [btrfs]                                                                                                                                          ? open_ctree+0xff6/0x132c [btrfs]
```
これはBtrfsが内部で管理しているログツリーと呼ばれるメタデータが壊れているためマウントが失敗したことを示しています。ファイルシステムがクラッシュした直後のmountがこの理由によって失敗することがあります。壊れたログは次のコマンドによって削除できます。その後もう一度ファイルシステムのmountを試してください。

```
$ btrfs-rescue zero-log /dev/sda2
```

このログツリーの削除によってどのような影響があるかについて説明します。Btrfsはメモリ上にキャッシュされたファイルシステムのデータを定期的(デフォルトでは30秒に一回)にストレージに同期させています。この同期操作のことをトランザクションコミットと呼びます。fsync()やO_SYNCで開いたファイルへの書き込みなどの同期書き込みについては、一旦ストレージ上のログツリーに保存した上で、トランザクションコミット時にデータ領域に反映させます。ログツリーを削除すると、最後のトランザクションコミットからクラッシュ時までの同期書き込みの結果を失います。

## 過去のsysylogに"chunk tree"という文字列を含むエラーが出力されている。

どのデバイスにどのデータを配置するかという情報が入っているchunk treeというメタデータが壊れている可能性があります。次のコマンドによって、ファイルシステムをスキャンしてchunk treeを復元できます。

```
$ btrfs-rescue chunk-recover /dev/sdb2
```

このコマンドはストレージプールのすべてを走査するため、非常に時間がかかる恐れがあります。

## それ以外のログが出ている、あるいはとくにログが出ていない

大きく分けて次の2つの可能性が考えられます。

- スーパーブロック(後述)が壊れている
- root tree(後述)が壊れている

それぞれについて対処方法を説明します。

## スーパーブロックが壊れている場合

スーパーブロックとは、mountしようとしたストレージがBtrfsに属していることを示すと共に、各種管理情報を保持しているメタデータです。このデータにはバックアップされていますので、スーパーブロックが壊れている場合は次のコマンドによって復元できます。

```
$ btrfs-rescue super-recover /dev/sda2
```

## root treeが壊れている場合

どの場所にどんなデータ/メタデータが配置されているかを管理するroot treeというメタデータが壊れている場合があります。次のコマンドを実行してください。


```
mount -o usebackuproot /dev/sdb2 /mnt
```

root treeの内容は定期的に更新されていきますが、過去のroot treeをバックアップとして保存しています。上記コマンドは、最新のroot treeのかわりにバックアップ用のroot treeを使用してBtrfsファイルシステムをmountします。mountに成功したとしても、root treeが過去のものである以上、データも過去のものになっていることにご注意ください。

## ファイルシステムの復元(最終手段)

次のコマンドによってファイルシステムの復元を試みます。

```
$ btrfs check --repair /dev/sda2
```

このコマンドは矛盾のあるデータは容赦無く削除するなどして無理矢理にでもmountできるようにするためのものであり、かつ、必ずしも成功するとは限りません。このため、他に打つ手がまったく無くなったときの最後の手段として使用してください。このコマンドの実行にはストレージプールの全走査が必要なため、ストレージプールのサイズに比例して実行時間が延びます。
